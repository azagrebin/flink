# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


#
# This file defines the Flink build for the "apache/flink" repository, including
# the following:
#  - PR builds (triggered through ci-bot)
#  - custom triggered e2e tests
#  - nightly builds

schedules:
- cron: "0 0 * * *"
  displayName: Nightly build
  branches:
    include:
    - master
  always: true # run even if there were no changes to the mentioned branches

trigger:
  branches:
    include:
    - '*'  # must quote since "*" is a YAML reserved character; we want a string

resources:
  containers:
  # Container with Maven 3.2.5, SSL to have the same environment everywhere.
  - container: flink-build-container
    image: rmetzger/flink-ci:ubuntu-amd64-bcef226

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  E2E_CACHE_FOLDER: $(Pipeline.Workspace)/e2e_cache
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  CACHE_KEY: maven | $(Agent.OS) | **/pom.xml, !**/target/**
  CACHE_FALLBACK_KEY: maven | $(Agent.OS)
  FLINK_ARTIFACT_DIR: $(Pipeline.Workspace)/flink_artifact
  SECRET_S3_BUCKET: $[variables.IT_CASE_S3_BUCKET]
  SECRET_S3_ACCESS_KEY: $[variables.IT_CASE_S3_ACCESS_KEY]
  SECRET_S3_SECRET_KEY: $[variables.IT_CASE_S3_SECRET_KEY]

jobs:
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci1
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci2
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci3
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci4
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci5
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci6
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci7
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8

  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci8
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci9
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
  - template: jobs-template.yml
    parameters: # see template file for a definition of the parameters.
      stage_name: ci10
      test_pool_definition:
        name: Default
      e2e_pool_definition:
        vmImage: 'ubuntu-16.04'
      environment: PROFILE="-Dhadoop.version=2.8.3 -Dinclude_hadoop_aws -Dscala-2.11"
      run_end_to_end: false
      container: flink-build-container
      jdk: jdk8
